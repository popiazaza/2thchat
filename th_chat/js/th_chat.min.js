var nzchatobj=jQuery.noConflict(),nzsid=getcookie("sid",!0),nztime1=(new Date).getTime(),nztime2=0,nztouid=0,nzquota=0,nzlastid=0,nzonol=!1,nzcommandz="",formhash="",nzChatPopupContent="",nzscroll=!0,nzChatRoom=0,nzChatList=0,nzInterval;function nzolover(){nzonol=!0}function nzolout(){nzonol=!1}function nzalert(n){nzchatobj("#nzalertbox").text(n),nzchatobj("#nzalertbox").slideDown(200),setTimeout(function(){nzchatobj("#nzalertbox").slideUp(200)},2e3)}function nzNotice(){nzcommandz="notice",nzchatobj(".nzquoteboxi").html('<div><span class="nzquoteboxh">แก้ไขประกาศ</span>: '+nzchatobj("#nzchatnotice").html()+'</div><div class="nzcancel" onclick="nzTouid(0)" title="ยกเลิก"></div>'),nzchatobj(".nzquoteboxo").show(),nzchatobj("#nzchatcontent").css("height",nzsetting.chatheight-nzchatobj(".nzquoteboxo").height()),nzScrollChat(!0),nzchatobj("#nzchatmessage").val(nzchatobj("#nzchatnotice").text()),nzchatobj("#nzchatmessage").focus()}function nzChatPopup(n){nzChatPopupContent=nzchatobj(n).next(".nzchatpopuph").html(),nzchatobj("#th_chat_popup_box").html(nzChatPopupContent),showWindow("th_chat_popup","plugin.php?id=th_chat:popup")}function nzSend(){var data=nzchatobj.trim(nzchatobj("#nzchatmessage").val());if(""===data)return!1;nztime1=(new Date).getTime(),nztime1>nztime2?(nzchatobj("#nzchatmessage").val(""),nztime2=nztime1+nzsetting.delay,nzchatobj.post("plugin.php?id=th_chat:post"+formhash,{text:data,lastid:nzlastid,touid:nztouid,quota:nzquota,command:nzcommandz,room:nzChatRoom},function(data){if((nzquota>0||"notice"==nzcommandz||"edit"==nzcommandz.substr(0,4))&&nzTouid(0),data=JSON.parse(data),1==data.type)nzalert(data.error),1==data.script&&eval(data.script);else if(nztouid==nzChatRoom){var listmess=sortObject(data);if(nzReadyForScroll(),nzchatobj.each(listmess,function(n,t){(n=parseInt(n))>nzlastid&&(nzlastid=n,nzchatobj("#afterme").before(t),nzScrollChat())}),nzchatobj(".nzinnercontent img").one("load",function(){nzScrollChat()}),1==nzsetting.iscleardata){var nzchatrr=nzchatobj(".nzchatrow");nzchatrr.size()>nzsetting.chatrowmax&&nzchatrr.first().remove()}}else nzChangeChatRoom(nztouid)})):nzalert("ส่งข้อความบ่อยไป")}function nzCommand(n,t){if(""==n)nzalert("คำสั่งผิดพลาด");else{if("del"==n)var o="ลบข้อความ",a=" "+nzchatobj("#nzchatcontent"+t).text();else{if("edit"==n)return nzTouid(0),nzcommandz="edit "+t,nzchatobj(".nzquoteboxi").html('<div><div class="nzquoteboxh">แก้ไขข้อความ</div>'+nzchatobj("#nzrows_"+t+" .nzinnercontent")[0].outerHTML+'</div><div class="nzcancel" onclick="nzTouid(0)" title="ยกเลิก"></div>'),nzchatobj(".nzquoteboxi .nzcq").remove(),nzchatobj(".nzquoteboxi .nzblockquote").remove(),nzchatobj(".nzquoteboxi .nztag").remove(),nzchatobj(".nzquoteboxi .nztag2").remove(),nzchatobj(".nzquoteboxi .nztag3").remove(),nzchatobj(".nzquoteboxo").show(),nzchatobj("#nzchatcontent").css("height",nzsetting.chatheight-nzchatobj(".nzquoteboxo").height()),nzScrollChat(!0),nzchatobj("#nzchatmessage").val(nzchatobj(".nzquoteboxi .nzinnercontent").text()),void nzchatobj("#nzchatmessage").focus();if("ban"==n)o="แบน",a=" "+nzchatobj("#nzolpro_"+t).text()+"(UID: "+t+")";else if("unban"==n)o="ปลดแบน",a=" "+nzchatobj("#nzolpro_"+t).text()+"(UID: "+t+")";else if("clear"==n)o="ล้างห้องแชท",a=""}1==confirm("คุณต้องการที่จะ"+o+a+" ?")&&(nzchatobj("#nzchatmessage").val("!"+n+" "+t),nzSend())}}function nzLoadTextInit(){nzchatobj.post("plugin.php?id=th_chat:newinit",{room:nzChatRoom,list:nzChatList},function(n){n=JSON.parse(n),nzlastid=n.lastid,nzchatobj("#nzchatcontent").html('<div class="nzcallrow">'+n.datahtml+'<div id="afterme"></div></div>'),nzScrollChat(!0),nzchatobj(".nzinnercontent img").one("load",function(){nzScrollChat()}),nzonol||nzchatobj("#nzchatolcontent").html(n.datachatonline),nzchatobj("#nzoltotal").html(n.chat_online_total),n.chat_unread&&n.chat_unread>0?(nzchatobj("#nzunread").html(n.chat_unread),nzchatobj("#nzunread").show()):nzchatobj("#nzunread").hide(),nzchatobj("#nzchatnotice").html(n.welcometext),nzResetInterval()})}function nzResetInterval(){clearInterval(nzInterval),nzInterval=setInterval(nzLoadText,nzsetting.reload)}function nzChangeChatRoom(n){nzChatRoom!==n&&(nzChatRoom=n,nzLoadTextInit())}function nzScrollChat(n=!1){var t=document.getElementById("nzchatcontent");n&&(nzscroll=!0,nzchatobj("#nznewmessage").hide()),nzscroll?t.scrollTop=t.scrollHeight:nzchatobj("#nznewmessage").show()}function nzReadyForScroll(){var n=document.getElementById("nzchatcontent");nzscroll=!!nzchatobj(".nzquoteboxo:visible")||n.scrollHeight-n.scrollTop==nzsetting.chatheight}function nzLoadText(){nzchatobj.post("plugin.php?id=th_chat:new",{room:nzChatRoom,list:nzChatList,lastid:nzlastid},function(n){var t=sortObject((n=JSON.parse(n)).chat_row);if(nzReadyForScroll(),nzchatobj.each(t,function(n,t){(n=parseInt(n))>nzlastid&&(nzlastid=n,nzchatobj("#afterme").before(t),nzScrollChat())}),nzchatobj(".nzinnercontent img").one("load",function(){nzScrollChat()}),1==nzsetting.iscleardata){var o=nzchatobj(".nzchatrow");o.size()>nzsetting.chatrowmax&&o.first().remove()}n.chat_online&&(nzonol||nzchatobj("#nzchatolcontent").html(n.chat_online),nzchatobj("#nzoltotal").html(n.chat_online_total)),n.chat_unread&&n.chat_unread>0?(nzchatobj("#nzunread").html(n.chat_unread),nzchatobj("#nzunread").show()):nzchatobj("#nzunread").hide(),nzResetInterval()})}function nzQuota(n){nzTouid(0),nzchatobj("#nzrows_"+n+" .nzuserat2")[0]?nzchatobj(".nzquoteboxi").html('<div class="nzinnercontent"><div class="nzblockquote">'+nzchatobj("#nzrows_"+n+" .nzuserat2")[0].outerHTML+": "+nzchatobj("#nzchatcontent"+n).html()+'</div></div><div class="nzcancel" onclick="nzTouid(0)" title="ยกเลิก"></div>'):nzchatobj(".nzquoteboxi").html('<div class="nzinnercontent"><div class="nzblockquote">'+nzchatobj("#nzchatcontent"+n).html()+'</div></div><div class="nzcancel" onclick="nzTouid(0)" title="ยกเลิก"></div>'),nzchatobj(".nzquoteboxi .nzcq").remove(),nzchatobj(".nzquoteboxi .nzuserat2").toggleClass("nzuserat2 nzuserat"),nzchatobj(".nzquoteboxo").show(),nzchatobj("#nzchatcontent").css("height",nzsetting.chatheight-nzchatobj(".nzquoteboxo").height()),nzScrollChat(!0),nzquota=n,nzchatobj("#nzchatmessage").focus()}function nzAt(n){seditor_insertunit("nzchat","@"+n+" ",""),nzchatobj("#nzchatmessage").focus()}function nzTouid(n){n>0?(nzTouid(0),nzchatobj(".nzquoteboxi").html('<div style="margin: 0 auto;"><span class="nzquoteboxh">แชทส่วนตัวกับ</span> <img src="uc_server/avatar.php?uid='+n+'&size=small" class="nzchatavatar" width="32" height="32" onerror="this.src=\'uc_server/images/noavatar_small.gif\';" align="absmiddle"> '+nzchatobj(".nzat_"+n).last()[0].outerHTML+'</div><div class="nzcancel" onclick="nzTouid(0)" title="ยกเลิก"></div>'),nzchatobj(".nzquoteboxi .nzcq").remove(),nzchatobj(".nzquoteboxi .nzinnercontent").remove(),nzchatobj(".nzquoteboxo").show(),nzchatobj("#nzchatcontent").css("height",nzsetting.chatheight-nzchatobj(".nzquoteboxo").height()),nztouid=n,nzChatRoom!==n&&nzChangeChatRoom(n)):(nzchatobj("#nzchatcontent").css("height",nzsetting.chatheight),"edit"==nzcommandz.substr(0,4)?nzchatobj(".nzquoteboxi .nzinnercontent").text()==nzchatobj("#nzchatmessage").val()&&nzchatobj("#nzchatmessage").val(""):"notice"==nzcommandz&&nzchatobj("#nzchatmessage").val()==nzchatobj("#nzchatnotice").text()&&nzchatobj("#nzchatmessage").val(""),nzchatobj(".nzquoteboxi").html(""),nzchatobj("#nztouid").html(""),nzchatobj(".nzquoteboxo").hide(),nztouid=0,nzquota=0,nzcommandz="",nzChatRoom>0&&nzChangeChatRoom(0))}function nzReload(){nzTouid(0),nzchatobj("#nzchatolcontent").html(""),nzchatobj("#nzchatnotice").html("กำลังโหลดประกาศล่าสุด..."),nzchatobj("#nzchatcontent").html('<br /><br /><br /><br /><br /><br /><center><img src="source/plugin/th_chat/images/loading.svg" alt="Load" /></center>'),nzchatobj.post("plugin.php?id=th_chat:newinit",function(n){n=JSON.parse(n),nzlastid=n.lastid,nzchatobj("#nzchatcontent").html('<table class="nzcallrow">'+n.datahtml+'<tr id="afterme" style="display: none;"><td class="nzavatart"></td><td class="nzcontentt"></td></tr></table>'),nzScrollChat(!0),nzchatobj(".nzinnercontent img").one("load",function(){nzScrollChat()}),nzchatobj("#nzchatolcontent").html(n.datachatonline),nzchatobj("#nzchatnotice").html(n.welcometext)})}function nzClean(){nzchatobj(".nzchatrow").fadeOut("slow")}function nzCheckImg(n){var t=parseInt(n.width),o=parseInt(n.height);t>500&&(n.style.cursor="pointer",n.onclick=function(){window.open(this.src,"ImageViewer","resizable=1").focus()},o*=500/t,t=500,n.height=o,n.width=t),o>240&&(n.style.cursor="pointer",n.onclick=function(){window.open(this.src,"ImageViewer","resizable=1").focus()},n.width=240/o*t,n.height=240)}function sortObject(n){var t,o={},a=[];for(t in n)n.hasOwnProperty(t)&&a.push(t);for(a.sort(),t=0;t<a.length;t++)o[a[t]]=n[a[t]];return o}nzchatobj.ajaxSetup({timeout:2e3,error:function(n,t,o){nzalert("เกิดข้อผิดพลาด: ไม่สามารถเชื่อมต่อกับเซิฟเวอร์ได้"),nzResetInterval()}}),nzchatobj(function(){nzchatobj("#nzchatmessage").keydown(function(n){"13"==n.keyCode&&nzSend(),"27"==n.keyCode&&nzTouid(0)}),nzchatobj("#nzchatmessage").bind("paste",function(n){if(1===n.originalEvent.clipboardData.files.length){nzchatobj("#nzimguploadl").text("กำลังอัปโหลด..."),nzchatobj("#nzimgupload").prop("disabled",!0);var t=new FormData;t.append("pictures",n.originalEvent.clipboardData.files[0]),nzchatobj("#nzimgupload").val(""),nzchatobj.ajax({url:"plugin.php?id=th_chat:img",type:"POST",data:t,cache:!1,dataType:"json",processData:!1,contentType:!1,success:function(n,t,o){void 0===n.error?(seditor_insertunit("nzchat","[img]"+n.url+"[/img]",""),nzchatobj("#nzchatmessage").focus()):nzalert(n.error)},error:function(n,t,o){nzalert("เกิดข้อผิดพลาด: "+t)},complete:function(n,t,o){nzchatobj("#nzimguploadl").text("อัปโหลดไฟล์ภาพ"),nzchatobj("#nzimgupload").prop("disabled",!1)}})}}),nzchatobj("#nzimgup").click(function(){nzchatobj("#nzimgupload").click()}),nzchatobj("#nzimgupload").change(function(){if(nzchatobj("#nzimgupload").val()){nzchatobj("#nzimguploadl").text("กำลังอัปโหลด..."),nzchatobj("#nzimgupload").prop("disabled",!0);var n=new FormData;n.append("pictures",nzchatobj("#nzimgupload").prop("files")[0]),nzchatobj("#nzimgupload").val(""),nzchatobj.ajax({url:"plugin.php?id=th_chat:img",type:"POST",data:n,cache:!1,dataType:"json",processData:!1,contentType:!1,success:function(n,t,o){void 0===n.error?(seditor_insertunit("nzchat","[img]"+n.url+"[/img]",""),nzchatobj("#nzchatmessage").focus()):nzalert(n.error)},error:function(n,t,o){nzalert("เกิดข้อผิดพลาด: "+t)},complete:function(n,t,o){nzchatobj("#nzimguploadl").text("อัปโหลดไฟล์ภาพ"),nzchatobj("#nzimgupload").prop("disabled",!1)}})}}),nzchatobj(".nzchat_general").click(function(){nzChatList=0,nzTouid(0),nzLoadTextInit(),nzchatobj(".nzchat_room").removeClass("nzactive"),nzchatobj(this).addClass("nzactive")}),nzchatobj(".nzchat_whisper").click(function(){nzChatList=1,nzLoadTextInit(),nzchatobj(".nzchat_room").removeClass("nzactive"),nzchatobj(this).addClass("nzactive")}),1==nzsetting.autoconnect&&nzLoadTextInit();nzchatobj("#nzemoji");const n=new EmojiButton;n.on("emoji",n=>{nzchatobj("#nzchatmessage").val(nzchatobj("#nzchatmessage").val()+n)}),nzchatobj("#nzemoji").click(function(){n.togglePicker(this)}),nzchatobj("#nznewmessage").click(function(){nzScrollChat(!0)}),nzchatobj("#nzchatmessage").keydown(function(n){"13"==n.keyCode&&nzSend()}),nzchatobj("#nzchatcontent").scroll(function(){var n=document.getElementById("nzchatcontent");n.scrollHeight-n.scrollTop==nzsetting.chatheight&&(nzchatobj("#nznewmessage").hide(),n.scrollTop=n.scrollHeight)})});